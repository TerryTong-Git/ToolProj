name: Research Code Review

on:
  pull_request:
    branches: [master, main]
    paths:
      - 'src/**/*.py'
      - 'docs/**/*.md'
      - 'docs/code_mapping.json'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

concurrency:
  group: code-review-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-methodology-alignment:
    name: Code-Methodology Alignment Check
    runs-on: ubuntu-latest
    outputs:
      review_status: ${{ steps.review.outputs.status }}
      misalignments: ${{ steps.review.outputs.misalignments }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT

          # Get changed source and doc files
          CHANGED_SRC=$(git diff --name-only $BASE_SHA $HEAD_SHA -- 'src/**/*.py' 2>/dev/null | tr '\n' ' ' || echo "")
          CHANGED_DOCS=$(git diff --name-only $BASE_SHA $HEAD_SHA -- 'docs/**/*.md' 'docs/code_mapping.json' 2>/dev/null | tr '\n' ' ' || echo "")

          echo "src_files=$CHANGED_SRC" >> $GITHUB_OUTPUT
          echo "doc_files=$CHANGED_DOCS" >> $GITHUB_OUTPUT

          # Check if any relevant files changed
          if [ -z "$CHANGED_SRC" ] && [ -z "$CHANGED_DOCS" ]; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

          echo "::notice::Changed source files: $CHANGED_SRC"
          echo "::notice::Changed documentation: $CHANGED_DOCS"

      - name: Skip if no relevant changes
        if: steps.changed-files.outputs.no_changes == 'true'
        run: |
          echo "::notice::No relevant source or documentation changes detected. Skipping review."
          exit 0

      - name: Run Research Code Review
        id: review
        if: steps.changed-files.outputs.no_changes != 'true'
        # continue-on-error allows the workflow to pass when first adding it
        # (OIDC validation requires workflow to exist on default branch)
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are a research code reviewer specializing in empirical ML/alignment research.
            Your task is to validate alignment between implementation code and methodology documentation.

            ## Context
            This is a research codebase for empirical alignment research experiments.
            The code_mapping.json file defines explicit relationships between methodology
            documentation and implementation files.

            ## Changed Files in This Commit/PR
            - Source files: ${{ steps.changed-files.outputs.src_files }}
            - Documentation files: ${{ steps.changed-files.outputs.doc_files }}

            ## Review Instructions

            ### Step 1: Load Code-Documentation Mapping
            Read `docs/code_mapping.json` to understand the relationships between
            methodology docs and implementation files.

            ### Step 2: Identify Affected Mappings
            For each changed file, find all related mappings in code_mapping.json.
            A change to a source file requires checking its corresponding methodology doc.
            A change to a methodology doc requires checking its corresponding implementations.

            ### Step 3: Validate Alignment
            For each affected mapping, verify:

            1. **Function Existence**: All `key_functions` listed in the mapping exist
               in the implementation files with matching names.

            2. **Signature Consistency**: Function signatures (parameters, return types
               if annotated) match what's documented in the methodology.

            3. **Algorithm Steps**: The implementation follows the algorithm steps
               described in the methodology document. Look for:
               - Step ordering matches documentation
               - All documented steps are implemented
               - No undocumented algorithmic changes

            4. **Parameter Alignment**: Variable names and parameters in code
               correspond to those described in docs (e.g., sigma_levels, noise_types).

            5. **Output Format**: Any output files or return structures match
               documented specifications.

            ### Step 4: Write Report File
            IMPORTANT: You MUST use the Write tool to create a file named `review-report.md`
            in the current directory. Use the following structure:

            ```markdown
            # Research Code Review Report

            **Status**: PASS | FAIL | WARN
            **Commit**: ${{ github.sha }}
            **Reviewer**: Claude Research Code Reviewer

            ## Summary
            [Brief 1-2 sentence summary]

            ## Files Reviewed
            - [List of files checked]

            ## Verified Alignments
            - [List what matched correctly]

            ## Issues Found
            ### Critical (FAIL)
            - [Missing functions, algorithm mismatches]

            ### Warnings (WARN)
            - [Minor inconsistencies, documentation gaps]

            ## Recommendations
            - [Specific fixes needed]
            ```

            Use FAIL status for:
            - Missing key_functions in implementation
            - Algorithm implementation doesn't match documented steps
            - Critical parameter mismatches

            Use WARN status for:
            - Documentation could be clearer
            - Minor naming inconsistencies
            - Suggested improvements

            Use PASS status when all validations succeed.

            CRITICAL: After completing your review, you MUST write the report to
            the file `review-report.md` using the Write tool. Do not just output
            the report - actually create the file.

      - name: Upload Review Report
        if: always() && steps.changed-files.outputs.no_changes != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: code-review-report-${{ github.sha }}
          path: review-report.md
          if-no-files-found: ignore
          retention-days: 30

      - name: Comment on PR
        if: steps.changed-files.outputs.no_changes != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let reportContent = '';

            try {
              reportContent = fs.readFileSync('review-report.md', 'utf8');
            } catch (e) {
              reportContent = 'Review report not generated. Check workflow logs.';
            }

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Research Code Review Report')
            );

            const commentBody = `## Research Code Review Report

            ${reportContent}

            ---
            *Automated review by Claude Research Code Reviewer*
            *Commit: ${{ github.sha }}*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: Check Review Status
        if: steps.changed-files.outputs.no_changes != 'true'
        run: |
          if [ -f review-report.md ]; then
            echo "=== Review Report ==="
            cat review-report.md
            echo "===================="

            if grep -q "^**Status**: FAIL" review-report.md; then
              echo "::error::Code-methodology misalignment detected. See review report for details."
              exit 1
            elif grep -q "^**Status**: WARN" review-report.md; then
              echo "::warning::Review completed with warnings. See review report for details."
              exit 0
            else
              echo "::notice::Review passed. Code and documentation are aligned."
              exit 0
            fi
          else
            if [ "${{ steps.review.outcome }}" = "failure" ]; then
              echo "::notice::Claude review step failed (expected on first PR adding this workflow due to OIDC validation). Will work after merge."
            else
              echo "::warning::Review report was not generated"
            fi
            exit 0
          fi

  quality-code-review:
    name: Quality Code Review
    runs-on: ubuntu-latest
    needs: code-methodology-alignment
    if: always() && needs.code-methodology-alignment.result != 'cancelled'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          # Get changed Python files
          CHANGED_PY=$(git diff --name-only $BASE_SHA $HEAD_SHA -- '*.py' 2>/dev/null | tr '\n' ' ' || echo "")

          echo "py_files=$CHANGED_PY" >> $GITHUB_OUTPUT

          if [ -z "$CHANGED_PY" ]; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

          echo "::notice::Changed Python files: $CHANGED_PY"

      - name: Skip if no Python changes
        if: steps.changed-files.outputs.no_changes == 'true'
        run: |
          echo "::notice::No Python file changes detected. Skipping quality review."
          exit 0

      - name: Run Quality Code Review
        id: quality-review
        if: steps.changed-files.outputs.no_changes != 'true'
        # continue-on-error allows the workflow to pass when first adding it
        # (OIDC validation requires workflow to exist on default branch)
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are a senior code reviewer focusing on code quality, security, and best practices.
            Your task is to review the changed Python code for quality issues.

            ## Changed Files
            Python files: ${{ steps.changed-files.outputs.py_files }}

            ## Review Focus Areas

            ### 1. Security
            - Check for OWASP Top 10 vulnerabilities
            - Look for command injection, SQL injection, XSS risks
            - Validate proper input sanitization
            - Check for hardcoded secrets or credentials
            - Review file path handling for path traversal

            ### 2. Correctness
            - Identify potential bugs and logic errors
            - Check edge cases and error handling
            - Validate type consistency
            - Look for off-by-one errors, null pointer issues

            ### 3. Performance
            - Identify inefficient algorithms (O(nÂ²) when O(n) possible)
            - Check for unnecessary memory allocations
            - Look for N+1 query patterns
            - Identify blocking operations in async code

            ### 4. Maintainability
            - Check code complexity (deeply nested logic)
            - Validate naming conventions and clarity
            - Look for code duplication
            - Check for proper error messages

            ### 5. Python Best Practices
            - Type hints usage and consistency
            - Proper exception handling (not bare except)
            - Resource management (context managers)
            - Import organization

            ## Review Instructions

            1. Read each changed file carefully
            2. For each issue found, note:
               - File and line number
               - Issue category (Security/Correctness/Performance/Maintainability)
               - Severity (Critical/High/Medium/Low)
               - Description of the problem
               - Suggested fix

            3. IMPORTANT: You MUST use the Write tool to create a file named
               `quality-review-report.md` in the current directory with this structure:

            ```markdown
            # Quality Code Review Report

            **Status**: PASS | FAIL | WARN
            **Commit**: ${{ github.sha }}
            **Reviewer**: Claude Quality Code Reviewer

            ## Summary
            [Brief summary of findings]

            ## Files Reviewed
            - [List of files]

            ## Issues Found

            ### Critical
            - [ ] **[File:Line]** - [Description] - [Category]

            ### High
            - [ ] **[File:Line]** - [Description] - [Category]

            ### Medium
            - [ ] **[File:Line]** - [Description] - [Category]

            ### Low
            - [ ] **[File:Line]** - [Description] - [Category]

            ## Positive Observations
            - [Good patterns noticed]

            ## Recommendations
            - [Actionable suggestions]
            ```

            Use FAIL for Critical or multiple High severity issues.
            Use WARN for High or multiple Medium severity issues.
            Use PASS when no significant issues found.

            CRITICAL: After completing your review, you MUST write the report to
            the file `quality-review-report.md` using the Write tool. Do not just
            output the report - actually create the file.

      - name: Upload Quality Review Report
        if: always() && steps.changed-files.outputs.no_changes != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: quality-review-report-${{ github.sha }}
          path: quality-review-report.md
          if-no-files-found: ignore
          retention-days: 30

      - name: Comment on PR
        if: steps.changed-files.outputs.no_changes != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let reportContent = '';

            try {
              reportContent = fs.readFileSync('quality-review-report.md', 'utf8');
            } catch (e) {
              reportContent = 'Quality review report not generated. Check workflow logs.';
            }

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Quality Code Review Report')
            );

            const commentBody = `## Quality Code Review Report

            ${reportContent}

            ---
            *Automated review by Claude Quality Code Reviewer*
            *Commit: ${{ github.sha }}*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: Check Quality Review Status
        if: steps.changed-files.outputs.no_changes != 'true'
        run: |
          if [ -f quality-review-report.md ]; then
            echo "=== Quality Review Report ==="
            cat quality-review-report.md
            echo "=============================="

            if grep -q "^**Status**: FAIL" quality-review-report.md; then
              echo "::error::Quality issues detected. See review report for details."
              exit 1
            elif grep -q "^**Status**: WARN" quality-review-report.md; then
              echo "::warning::Quality review completed with warnings. See review report for details."
              exit 0
            else
              echo "::notice::Quality review passed."
              exit 0
            fi
          else
            if [ "${{ steps.quality-review.outcome }}" = "failure" ]; then
              echo "::notice::Claude review step failed (expected on first PR adding this workflow due to OIDC validation). Will work after merge."
            else
              echo "::warning::Quality review report was not generated"
            fi
            exit 0
          fi
